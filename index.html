<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioTranscriptor AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6d5dfc;
            --background-color: #f0f2f5;
            --surface-color: rgba(255, 255, 255, 0.7);
            --text-color: #0f172a;
            --subtle-text-color: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(109, 93, 252, 0.2);
            --error-color: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background: var(--background-color);
            background-image: linear-gradient(135deg, #a855f7, #3b82f6);
            color: var(--text-color);
        }

        .app-container {
            width: 90%; max-width: 500px; background: var(--surface-color);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 24px; border: 1px solid var(--border-color);
            padding: 2.5rem; box-shadow: 0 8px 32px 0 var(--shadow-color); transition: all 0.3s ease;
        }

        .view { display: none; }
        .view.active { display: block; }

        h1 { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem; }
        .subtitle { text-align: center; margin-bottom: 2rem; color: var(--subtle-text-color); }
        .form-group { margin-bottom: 1.25rem; }

        input {
            width: 100%; padding: 1rem; border: 1px solid #d1d5db; border-radius: 12px;
            font-size: 1rem; background: #fff; transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--shadow-color); }

        button {
            width: 100%; padding: 1rem; color: white; border: none; border-radius: 12px;
            cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s;
            background-image: linear-gradient(to right, var(--primary-color) 0%, #8678f9 51%, var(--primary-color) 100%);
            background-size: 200% auto;
        }
        button:hover { background-position: right center; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }

        #recordButton {
            margin-top: 1rem;
            background-image: linear-gradient(to right, #10b981 0%, #34d399 51%, #10b981 100%);
        }
        #recordButton.is-recording {
            background-image: linear-gradient(to right, #ef4444 0%, #f87171 51%, #ef4444 100%);
        }

        #logoutButton { margin-top: 1rem; background-image: none; background-color: #e2e8f0; color: var(--subtle-text-color); }
        #logoutButton:hover { background-color: #d1d5db; }

        .message { margin-top: 1rem; padding: 0.75rem 1rem; border-radius: 8px; text-align: center; font-weight: 500; }
        .message.error { background-color: #fee2e2; color: #991b1b; }

        #drop-area {
            border: 2px dashed #d1d5db; border-radius: 16px; padding: 2.5rem; text-align: center;
            cursor: pointer; transition: border-color 0.3s, background-color 0.3s;
        }
        #drop-area.highlight { border-color: var(--primary-color); background-color: rgba(255, 255, 255, 0.5); }
        #drop-area .upload-icon { width: 48px; height: 48px; margin: 0 auto 1rem; color: var(--primary-color); }
        #file-info { margin-top: 1rem; font-weight: 500; color: var(--subtle-text-color); }
        #file-info.error { color: var(--error-color); }

        #recording-status { display: none; margin-top: 1rem; font-weight: 500; color: var(--error-color); text-align: center; }

        .animation-container { display: none; margin: 2rem 0; text-align: center; }
        .waveform { display: flex; justify-content: center; align-items: center; height: 50px; }
        .waveform .bar { width: 6px; height: 10px; margin: 0 4px; background-color: var(--primary-color); animation: wave 1.2s infinite ease-in-out; }
        .waveform .bar:nth-child(2) { animation-delay: -1.1s; }
        .waveform .bar:nth-child(3) { animation-delay: -1.0s; }
        .waveform .bar:nth-child(4) { animation-delay: -0.9s; }
        .waveform .bar:nth-child(5) { animation-delay: -0.8s; }
        @keyframes wave { 0%, 40%, 100% { transform: scaleY(0.4); } 20% { transform: scaleY(1.0); } }
        .animation-text { margin-top: 1rem; font-weight: 600; }

        #result-wrapper { display: none; margin-top: 2rem; }
        #result-container { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; position: relative; cursor: copy; transition: background-color 0.2s; }
        #result-container:hover { background-color: #f1f5f9; }
        #transcriptionResult { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; }
        #durationInfo { margin-top: 1rem; text-align: right; font-size: 0.9rem; font-weight: 500; color: var(--subtle-text-color); }

        .copy-feedback { position: absolute; top: 1rem; right: 1rem; background-color: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(-10px); }
        .copy-feedback.show { opacity: 1; transform: translateY(0); }

        @media (max-width: 600px) { .app-container { padding: 1.5rem; margin: 1rem; width: auto; } h1 { font-size: 1.75rem; } .subtitle { font-size: 0.9rem; } #drop-area { padding: 1.5rem; } }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="loginView" class="view">
            <h1>Bienvenido</h1>
            <p class="subtitle">Inicia sesión para transcribir tus audios</p>
            <form id="loginForm">
                <div class="form-group"><input type="text" id="usuario" placeholder="Usuario" required></div>
                <div class="form-group"><input type="password" id="password" placeholder="Contraseña" required></div>
                <button type="submit">Ingresar</button>
            </form>
            <div id="loginMessage"></div>
        </div>

        <div id="transcriptionView" class="view">
            <h1>Sube o Graba tu Audio</h1>
            <p class="subtitle">Arrastra un archivo, graba o selecciona para transcribir</p>
            <div id="drop-area">
                <input type="file" id="fileElem" accept="audio/*,video/*" style="display:none">
                <div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM21 21H3" /></svg></div>
                <p>Arrastra un archivo aquí o <strong>haz clic para seleccionar</strong></p>
                <div id="file-info"></div>
            </div>
            <button id="recordButton">Grabar Audio</button>
            <div id="recording-status"></div>
            <div class="animation-container" id="animationContainer">
                <div class="waveform"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                <div class="animation-text">Transcribiendo...</div>
            </div>
            <div id="result-wrapper">
                <div id="result-container" title="Haz clic para copiar"><div id="transcriptionResult"></div><div class="copy-feedback" id="copyFeedback">¡Copiado!</div></div>
                <div id="durationInfo"></div>
            </div>
            <button id="logoutButton">Cerrar Sesión</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginView = document.getElementById('loginView');
            const transcriptionView = document.getElementById('transcriptionView');
            const loginForm = document.getElementById('loginForm');
            const loginMessage = document.getElementById('loginMessage');
            const logoutButton = document.getElementById('logoutButton');
            const recordButton = document.getElementById('recordButton');
            const recordingStatus = document.getElementById('recording-status');
            const dropArea = document.getElementById('drop-area');
            const fileElem = document.getElementById('fileElem');
            const fileInfo = document.getElementById('file-info');
            const animationContainer = document.getElementById('animationContainer');
            const resultWrapper = document.getElementById('result-wrapper');
            const resultContainer = document.getElementById('result-container');
            const transcriptionResult = document.getElementById('transcriptionResult');
            const durationInfo = document.getElementById('durationInfo');
            const copyFeedback = document.getElementById('copyFeedback');

            let mediaRecorder;
            let audioChunks = [];
            let mediaStream;

            const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25MB

            const checkLoginState = () => {
                if (localStorage.getItem('isLoggedIn') === 'true') {
                    loginView.classList.remove('active');
                    transcriptionView.classList.add('active');
                } else {
                    loginView.classList.add('active');
                    transcriptionView.classList.remove('active');
                }
            };

            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const webhookUrl = 'https://lpwebhook.luispinta.com/webhook/3ff2b48f-eba9-45fe-8754-8553280f0506';
                try {
                    const response = await fetch(webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usuario: document.getElementById('usuario').value, password: document.getElementById('password').value }) });
                    const result = await response.json();
                    if (result.status === 'autorizado') {
                        localStorage.setItem('isLoggedIn', 'true');
                        checkLoginState();
                    } else {
                        loginMessage.className = 'message error';
                        loginMessage.textContent = result.message || 'Credenciales incorrectas.';
                    }
                } catch (error) { loginMessage.className = 'message error'; loginMessage.textContent = 'Error de conexión.'; }
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('isLoggedIn');
                fileInfo.textContent = '';
                resultWrapper.style.display = 'none';
                checkLoginState();
            });

            recordButton.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            dropArea.addEventListener('click', () => fileElem.click());
            fileElem.addEventListener('change', (e) => handleFiles(e.target.files));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { dropArea.addEventListener(eventName, preventDefaults, false); document.body.addEventListener(eventName, preventDefaults, false); });
            ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false));
            ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false));
            dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);

            resultContainer.addEventListener('click', () => {
                if (transcriptionResult.textContent) { navigator.clipboard.writeText(transcriptionResult.textContent).then(() => { copyFeedback.classList.add('show'); setTimeout(() => copyFeedback.classList.remove('show'), 2000); }); }
            });

            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

            function handleFiles(files) {
                if (files.length === 0) return;
                const file = files[0];
                fileInfo.className = '';
                if (file.size > MAX_FILE_SIZE) {
                    fileInfo.textContent = `Error: El archivo excede el límite de 25MB.`;
                    fileInfo.className = 'error';
                    return;
                }
                fileInfo.textContent = `Archivo: ${file.name}`;
                uploadAndTranscribe(file);
            }

            async function startRecording() {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(mediaStream);
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioFile = new File([audioBlob], "grabacion.webm", { type: 'audio/webm' });
                        audioChunks = [];
                        uploadAndTranscribe(audioFile);
                        mediaStream.getTracks().forEach(track => track.stop());
                    };
                    audioChunks = [];
                    mediaRecorder.start();
                    recordButton.textContent = 'Detener Grabación';
                    recordButton.classList.add('is-recording');
                    recordingStatus.textContent = 'Grabando...';
                    recordingStatus.style.display = 'block';
                    dropArea.style.pointerEvents = 'none';
                    dropArea.style.opacity = '0.5';
                } catch (err) {
                    recordingStatus.textContent = 'Error al acceder al micrófono.';
                    console.error("Error de MediaRecorder:", err);
                }
            }

            function stopRecording() {
                mediaRecorder.stop();
                recordButton.textContent = 'Grabar Audio';
                recordButton.classList.remove('is-recording');
                recordingStatus.style.display = 'none';
                dropArea.style.pointerEvents = 'auto';
                dropArea.style.opacity = '1';
            }

            async function uploadAndTranscribe(file) {
                const webhookUrl = 'https://lpn8n.luispinta.com/webhook/22a5f1a5-8792-4622-bcca-f744f95f5cea';
                const formData = new FormData();
                formData.append('file', file);
                animationContainer.style.display = 'block';
                resultWrapper.style.display = 'none';
                recordButton.disabled = true;
                try {
                    const response = await fetch(webhookUrl, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`Error del servidor: ${response.statusText}`);
                    const result = await response.json();
                    let transcriptionText = '', durationText = '';
                    const data = Array.isArray(result) ? result[0] : result;
                    if (data && data.text) {
                        transcriptionText = data.text;
                        if (data.usage && typeof data.usage.seconds !== 'undefined') {
                            durationText = `Duración: ${data.usage.seconds.toFixed(2)} segundos`;
                        }
                    } else {
                        transcriptionText = 'No se pudo extraer la transcripción. Respuesta: ' + JSON.stringify(result, null, 2);
                    }
                    transcriptionResult.textContent = transcriptionText;
                    durationInfo.textContent = durationText;
                    resultWrapper.style.display = 'block';
                } catch (error) {
                    transcriptionResult.textContent = `Error en la transcripción: ${error.message}`;
                    durationInfo.textContent = '';
                    resultWrapper.style.display = 'block';
                } finally {
                    animationContainer.style.display = 'none';
                    recordButton.disabled = false;
                }
            }

            checkLoginState();
        });
    </script>

</body>
</html>
